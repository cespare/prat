Taken from bzr revno 190
